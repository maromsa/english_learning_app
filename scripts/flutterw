#!/usr/bin/env bash

set -euo pipefail

ROOT_DIR="$(cd -- "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
ENV_FILE="$ROOT_DIR/.env"

# Load environment variables from .env if available (without exporting functions)
if [[ -f "$ENV_FILE" ]]; then
  # shellcheck source=/dev/null
  set -a
  source "$ENV_FILE"
  set +a
fi

args=("$@")

has_define() {
  local key="$1"
  for existing in "${args[@]}"; do
    if [[ "$existing" == --dart-define=${key}=* ]]; then
      return 0
    fi
  done
  return 1
}

if ! has_define GEMINI_API_KEY && [[ -n "${GEMINI_API_KEY:-}" ]]; then
  args+=("--dart-define=GEMINI_API_KEY=${GEMINI_API_KEY}")
fi

if ! has_define GEMINI_PROXY_URL && [[ -n "${GEMINI_PROXY_URL:-}" ]]; then
  args+=("--dart-define=GEMINI_PROXY_URL=${GEMINI_PROXY_URL}")
fi

if ! has_define AI_IMAGE_VALIDATION_URL && [[ -n "${AI_IMAGE_VALIDATION_URL:-}" ]]; then
  args+=("--dart-define=AI_IMAGE_VALIDATION_URL=${AI_IMAGE_VALIDATION_URL}")
fi

if ! has_define GEMINI_API_KEY && [[ -z "${GEMINI_API_KEY:-}" ]] && \
   ! has_define GEMINI_PROXY_URL && [[ -z "${GEMINI_PROXY_URL:-}" ]]; then
  echo "[flutterw] error: GEMINI_API_KEY or GEMINI_PROXY_URL is required. Provide one via .env, the environment, or pass the corresponding --dart-define flag." >&2
  exit 1
fi

set -- "${args[@]}"
exec flutter "$@"
