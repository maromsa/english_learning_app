# שיפור ניהול משתמשים - הצגה ברורה ומעבר קל בין משתמשים

## רקע והקשר

האפליקציה תומכת בשני סוגי משתמשים:
1. **משתמשים מקומיים** (LocalUser) - נשמרים במכשיר, עם שם, גיל, תמונה
2. **משתמשי Google/Firebase** - משתמשים מחוברים לחשבון Google

כרגע הבעיות:
- אין הצגה ברורה של המשתמש הנוכחי במסכים השונים
- אין דרך קלה לעבור בין משתמשים מבלי לצאת מהמסך הנוכחי
- המשתמש לא יודע מי המשתמש הפעיל כרגע
- צריך ללכת דרך מסך בחירת משתמשים (UserSelectionScreen) כדי לעבור בין משתמשים

## דרישות

### 1. הצגת המשתמש הנוכחי במפה (MapScreen)

**מיקום**: ב-AppBar של MapScreen, בצד שמאל (leading)

**תצוגה**:
- אם יש משתמש מקומי פעיל: הצג תמונה/אווטר + שם המשתמש
- אם יש משתמש Google פעיל: הצג תמונה/אווטר + שם + אייקון Google
- אם אין משתמש פעיל: הצג אייקון ברירת מחדל

**עיצוב**:
- עגול או מעוגל, עם גבול עדין
- לחץ עליו יפתח תפריט/דיאלוג עם אפשרויות:
  - הצגת פרטי המשתמש הנוכחי (שם, גיל, תמונה)
  - כפתור "עבור למשתמש אחר" - פותח מסך בחירת משתמשים
  - כפתור "יצירת משתמש חדש" - פותח מסך יצירת משתמש
  - אם משתמש מקומי: כפתור "קשר ל-Google"
  - אם משתמש Google: הצגת אימייל

**קוד קיים רלוונטי**:
- `lib/screens/map_screen.dart` - המפה הראשית
- `lib/screens/user_selection_screen.dart` - מסך בחירת משתמשים
- `lib/providers/auth_provider.dart` - ניהול משתמשי Google
- `lib/services/local_user_service.dart` - ניהול משתמשים מקומיים
- `lib/models/local_user.dart` - מודל משתמש מקומי
- `lib/widgets/character_avatar.dart` - אווטר דמות (יכול לשמש השראה)
- `lib/widgets/optimized_avatar.dart` - אווטר מותאם (כבר קיים)

### 2. תפריט/דיאלוג מעבר בין משתמשים

**כשנלחץ על האווטר במפה**:
- פתח תפריט נפתח (DropdownMenu) או BottomSheet יפה
- הצג את המשתמש הנוכחי בבירור (עם סימון "פעיל" או צבע שונה)
- הצג רשימת כל המשתמשים הזמינים (מקומיים + Google אם מחובר)
- אפשר מעבר מהיר בין משתמשים בלחיצה אחת
- כל משתמש יוצג עם: תמונה, שם, גיל (אם רלוונטי), סטטוס (מקומי/Google)

**פונקציונליות**:
- לחיצה על משתמש אחר → מעבר מיידי למשתמש הזה (ללא צורך לעבור דרך UserSelectionScreen)
- עדכן את כל ה-Providers (CoinProvider, ShopProvider, AchievementService)
- טען מחדש את הנתונים של המשתמש החדש
- עדכן את המפה והמטבעות
- הצג הודעה קצרה "עברת למשתמש: [שם]"

### 3. הצגה עקבית בכל המסכים

**מיקומים נוספים** (אופציונלי, אבל מומלץ):
- SettingsScreen - הצגת המשתמש הנוכחי + כפתור מעבר
- ShopScreen - הצגה קטנה של המשתמש
- כל מסך ראשי אחר

### 4. שיפורים טכניים

**Provider חדש או שיפור קיים**:
- שקול ליצור `CurrentUserProvider` שמנהל את המשתמש הנוכחי
- או לשפר את `AuthProvider` כך שיכלול גם משתמשים מקומיים
- וודא שכל ה-Providers מתעדכנים כשעוברים בין משתמשים

**פונקציות עזר**:
- פונקציה `getCurrentUserDisplayName()` - מחזירה את שם המשתמש הנוכחי (מקומי או Google)
- פונקציה `getCurrentUserAvatar()` - מחזירה את תמונת המשתמש הנוכחי
- פונקציה `switchUser(userId, isLocal)` - מעבר בין משתמשים

## דרישות עיצוב

1. **עקביות**: השתמש בעיצוב דומה ל-CharacterAvatar או OptimizedAvatar שכבר קיימים
2. **נגישות**: וודא שהאווטר גדול מספיק ללחיצה נוחה (מינימום 40x40)
3. **אסתטיקה**: עיצוב נקי ומודרני, תואם לעיצוב הקיים של האפליקציה
4. **אנימציות**: מעבר חלק בין משתמשים עם אנימציה עדינה

## דוגמאות קוד קיימות

- `lib/screens/map_screen.dart` - שורה 900-918: CharacterAvatar ב-AppBar (leading)
- `lib/screens/user_selection_screen.dart` - שורה 397-498: _UserCard - כיצד להציג משתמש
- `lib/screens/user_selection_screen.dart` - שורה 305-395: _GoogleHeroCard - כיצד להציג משתמש Google

## הערות חשובות

1. **שמירת נתונים**: וודא שכל הנתונים נשמרים לפני מעבר למשתמש אחר
2. **טעינה מחדש**: אחרי מעבר משתמש, טען מחדש את המטבעות, הכוכבים, וההתקדמות
3. **טיפול בשגיאות**: וודא טיפול נכון בשגיאות אם משתמש לא קיים או יש בעיה בטעינה
4. **ביצועים**: וודא שהמעבר בין משתמשים מהיר ולא חוסם את ה-UI

## סדר ביצוע מומלץ

1. יצירת/שיפור Provider לניהול המשתמש הנוכחי
2. הוספת אווטר משתמש ב-AppBar של MapScreen
3. יצירת תפריט/דיאלוג מעבר בין משתמשים
4. הוספת פונקציונליות מעבר מהיר בין משתמשים
5. בדיקות ועיצוב סופי

## תוצאה צפויה

לאחר השינויים:
- המשתמש יראה תמיד מי המשתמש הפעיל
- מעבר בין משתמשים יהיה מהיר ונוח (לחיצה אחת)
- חוויית המשתמש תהיה ברורה ומסודרת יותר
- לא יהיה צורך לעבור דרך מסך בחירת משתמשים בכל פעם

---

**הערה**: השתמש בקוד הקיים כבסיס, שפר אותו, והוסף את הפונקציונליות הנדרשת. וודא שהכל עובד חלק עם המערכת הקיימת של ניהול משתמשים.











