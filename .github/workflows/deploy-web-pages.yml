name: Deploy Flutter Web to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  FLUTTER_CHANNEL: stable

jobs:
  build:
    name: Build Flutter web bundle
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Install dependencies
        run: flutter pub get

      - name: Build Flutter web
        env:
          GEMINI_PROXY_URL: ${{ secrets.GEMINI_PROXY_URL }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          FIREBASE_USER_ID_FOR_UPLOAD: ${{ secrets.FIREBASE_USER_ID_FOR_UPLOAD }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          GOOGLE_TTS_API_KEY: ${{ secrets.GOOGLE_TTS_API_KEY }}
          AI_IMAGE_VALIDATION_URL: ${{ secrets.AI_IMAGE_VALIDATION_URL }}
        run: |
          set -eo pipefail

          dart_defines=()
          add_define() {
            local name="$1"
            local value="$2"
            if [ -n "$value" ]; then
              dart_defines+=("--dart-define=${name}=${value}")
            fi
          }

          add_define GEMINI_PROXY_URL "$GEMINI_PROXY_URL"
          add_define PIXABAY_API_KEY "$PIXABAY_API_KEY"
          add_define FIREBASE_USER_ID_FOR_UPLOAD "$FIREBASE_USER_ID_FOR_UPLOAD"
          add_define CLOUDINARY_CLOUD_NAME "$CLOUDINARY_CLOUD_NAME"
          add_define CLOUDINARY_API_KEY "$CLOUDINARY_API_KEY"
          add_define CLOUDINARY_API_SECRET "$CLOUDINARY_API_SECRET"
          add_define GOOGLE_TTS_API_KEY "$GOOGLE_TTS_API_KEY"
          add_define AI_IMAGE_VALIDATION_URL "$AI_IMAGE_VALIDATION_URL"

          if [ "${#dart_defines[@]}" -gt 0 ]; then
            echo "Injecting ${#dart_defines[@]} secret(s) via --dart-define."
          else
            echo "No secrets provided; building with default config."
          fi

          flutter build web --release --base-href "/${{ github.event.repository.name }}/" "${dart_defines[@]}"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/web

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4
