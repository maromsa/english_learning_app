name: Upload Debug Build to Appetize

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  FLUTTER_CHANNEL: stable

jobs:
  build-and-upload:
    name: Build Android Debug APK and upload to Appetize
    runs-on: ubuntu-latest
    if: ${{ (secrets.APPETIZE_API_TOKEN != '') || (vars.APPETIZE_API_TOKEN != '') }}
    permissions:
      contents: read

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Install dependencies
        run: flutter pub get

      - name: Build Android debug APK
        run: flutter build apk --debug

      - name: Display generated files
        run: ls build/app/outputs/flutter-apk

      - name: Upload build to Appetize
        id: upload_appetize
        env:
          APPETIZE_API_TOKEN: ${{ secrets.APPETIZE_API_TOKEN || vars.APPETIZE_API_TOKEN }}
          APPETIZE_PUBLIC_KEY: ${{ secrets.APPETIZE_PUBLIC_KEY || vars.APPETIZE_PUBLIC_KEY }}
        run: |
          set -euo pipefail

            if [ -z "${APPETIZE_API_TOKEN:-}" ]; then
              echo "::error::Missing Appetize API token. Set APPETIZE_API_TOKEN as a secret or repository variable."
              exit 1
            fi

          APK_PATH="build/app/outputs/flutter-apk/app-debug.apk"
          if [ ! -f "$APK_PATH" ]; then
            echo "::error::APK not found at $APK_PATH"
            exit 1
          fi

          echo "Uploading to Appetize..."

          response_file=$(mktemp)

          http_code=$(curl -sS \
            -u "${APPETIZE_API_TOKEN}:" \
            -X POST https://api.appetize.io/v1/apps \
            -F "platform=android" \
            -F "file=@${APK_PATH}" \
            -F "note=Automated upload from GitHub Actions" \
            ${APPETIZE_PUBLIC_KEY:+-F "publicKey=${APPETIZE_PUBLIC_KEY}"} \
            -o "$response_file" \
            -w '%{http_code}'
          )

          if [ "$http_code" -ge 400 ]; then
            echo "::error::Appetize upload failed with status $http_code"
            cat "$response_file"
            exit 1
          fi

          public_key=$(jq -r '.publicKey // empty' "$response_file")
          app_url=$(jq -r '.appURL // empty' "$response_file")

          if [ -z "$public_key" ]; then
            echo "::error::Missing public key in Appetize response"
            cat "$response_file"
            exit 1
          fi

          rm -f "$response_file"

          echo "public_key=$public_key"
          if [ -n "$app_url" ]; then
            echo "app_url=$app_url"
          fi

          echo "public_key=$public_key" >> "$GITHUB_OUTPUT"
          if [ -n "$app_url" ]; then
            echo "app_url=$app_url" >> "$GITHUB_OUTPUT"
          fi

      - name: Post upload summary
        if: steps.upload_appetize.outputs.public_key != ''
        run: |
          echo "Appetize Public Key: ${{ steps.upload_appetize.outputs.public_key }}"
          if [ -n "${{ steps.upload_appetize.outputs.app_url }}" ]; then
            echo "Preview URL: ${{ steps.upload_appetize.outputs.app_url }}"
          fi
